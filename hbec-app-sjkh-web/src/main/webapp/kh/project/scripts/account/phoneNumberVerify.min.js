/**
 * 手机号码验证
 */
define("project/scripts/account/phoneNumberVerify", function (require, exports, module) {
    /* 私有业务模块的全局变量 begin */
    var $ = jQuery = require('jquery');
    var appUtils = require("appUtils"),
        servicePrant = require("serviceImp"),
        service,  //业务层接口，请求数据
        gconfig = require("gconfig"),
        layerUtils = require("layerUtils"), // 弹出层对象
        utils = require("utils"),
        validatorUtil = require("validatorUtil"),
        _pageId = "#account_phoneNumberVerify",
        backUrl = "";
    /* 私有业务模块的全局变量 end */

    function init() {
        console.log('111');
        console.log(require("serviceImp"));
        console.log('222');
        //加载样式
        getEvent(".page").height($(window).height());
        getEvent(".over_scroll").height($(window).height() - 45).css({overflow: "auto"});
        if (appUtils.getSStorageInfo("mobileNo") == "") {
            getEvent(".phoneNum").css({color: "#E3E3E3"}).val("请输入手机号码");
        } else {
            getEvent(".phoneNum").css({color: "#2F2F2F"}).val(appUtils.getSStorageInfo("mobileNo"));
        }

        console.log("sumTimeRegistered" + appUtils.getSStorageInfo("mobileNo") + "sumTime_unregistered_key get:" + appUtils.getSStorageInfo("sumTimeRegistered" + appUtils.getSStorageInfo("mobileNo")));
        backUrl = appUtils.getPageParam("backUrl");

        service = servicePrant.getInstance;
    }

    function bindPageEvent() {
        /* 绑定返回事件 */
        appUtils.bindEvent($(_pageId + " .header .icon_back"), function () {
            appUtils.pageInit("account/phoneNumberVerify", "account/openAccount", {backUrl: backUrl});
        });

        /* 限制手机号在IOS上的长度 */
        appUtils.bindEvent($(_pageId + " .phoneNum"), function () {
            utils.dealIPhoneMaxLength(this, 11); //处理iphone兼容
        }, "input");


        /* 下一步(继续开户) */
        appUtils.bindEvent(getEvent(".fix_bot .ct_btn"), function () {
            var mobileNo = getEvent(".phoneNum").val();
            if (mobileNo.length == 0) {
                layerUtils.iMsg(-1, "请输入手机号！");
                return;
            }
            var telReg = !!mobileNo.match(/^(1\d{10})$/);
            //如果手机号码不能通过验证
            if (telReg == false) {
                layerUtils.iMsg(-1, "请输入正确格式的手机号！");
                return;
            }

            //如果用户回退到输入手机号页面,用户未修改手机号码,并且短信验证通过,直接进入
            if (appUtils.getSStorageInfo("smsCodeVail") == "true" && mobileNo == appUtils.getSStorageInfo("mobileNo")) {
                if (backUrl != null && backUrl != "" && backUrl != "undefined") {
                    appUtils.pageInit("account/phoneNumberVerify", backUrl);
                    return;
                }
                appUtils.pageInit("account/phoneNumberVerify", "account/selDepartment");
                return;
            } else {
                //用户更换手机则清除缓存
                appUtils.clearSStorage();
                //设置新开户标示
                appUtils.setSStorageInfo("openChannel", "new");
            }

            //获取用户当前网络请求,ip,mac
            utils.getIp();

            var param = {
                "step": "isToukerUser",
                "mobileNo": mobileNo
            };

            var returnData = "";
            if (utils.isAndroid()) {
                returnData = khmobile.requestUrlParamsEncoding(utils.jsonToParams(param));
                toukerServerPluginCallback(returnData);
            } else {
                require("shellPlugin").callShellMethod("toukerServerPlugin", function (rtnparam) {
                    toukerServerPluginCallback(rtnparam);
                }, function (data) {
                }, {"command": "requestUrlParamsEncoding", "params": utils.jsonToParams(param)});
            }
            function toukerServerPluginCallback(returnData) {
                service.hbAjax(returnData, function (data) {
                    appUtils.setSStorageInfo("mobileNo", mobileNo);// 保存手机号码到缓存中
                    if (data.errorNo == 0 && data.errorMsg == "1") {
                        var client_id = data.results.dataSet.client_id;
                        if (client_id != null) {
                            appUtils.setSStorageInfo("khh", client_id);//将客户号号加入到缓存中
                        } else {
                            appUtils.setSStorageInfo("khh", ""); //清空客户号
                        }
                        appUtils.pageInit("account/phoneNumberVerify", "account/phoneCodeVerify");
                    } else if (data.errorNo == 0 && data.errorMsg == "0") { // 没有在投客网注册用户  走注册流程
                        appUtils.pageInit("account/phoneNumberVerify", "account/phoneToukerRegister");
                    } else {
                        layerUtils.iMsg(-1, "系统异常，请稍后重试！");
                    }
                });
            }
        });
    }

    //获取当前页面属性对象
    function getEvent(event) {
        return $(_pageId + " " + event);
    }

    function destroy() {
        service.destroy();
    }

    var phoneNumberVerify = {
        "init": init,
        "bindPageEvent": bindPageEvent,
        "destroy": destroy
    };

    //暴露接口
    module.exports = phoneNumberVerify;
});